<?php

/**
 * @file
 * Defines features and functions common to the 
 * Commerce Abandoned Cart Notification module.
 */

/**
 * Implements hook_commerce_order_status_info().
 */
function commerce_abandoned_cart_notification_commerce_order_status_info() {
  $order_statuses = array();

  // Create a new status for orders whom already received a notification.
  $order_statuses['user_notified'] = array(
    'name' => 'user_notified',
    'title' => t('User notified'),
    'state' => 'cart',
    'weight' => 2,
  );

  return $order_statuses;
}

/**
 * Implements hook_views_api().
 */
function commerce_abandoned_cart_notification_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'commerce_abandoned_cart_notification') . '/includes/views',
  );
}

/**
 * Retrieve the first line item of an order that references a product.
 */
function commerce_abandoned_cart_notification_first_product_line_item($order) {
  $ids = array_map('_commerce_abandoned_cart_notification_order_line_item_ids', $order->commerce_line_items[LANGUAGE_NONE]);
  $line_items = commerce_line_item_load_multiple($ids);
  foreach ($line_items as $line_item) {
    if ($line_item->type == 'product') {
      return $line_item;
    }
  }
  return FALSE;
}

function _commerce_abandoned_cart_notification_order_line_item_ids($line_item) {
  return $line_item['line_item_id'];
}
